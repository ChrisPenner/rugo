<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Rugo - Go Game</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            font-family: Arial, sans-serif;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        
        #game-canvas {
            border: 2px solid #8B4513;
            background-color: #DEB887;
            cursor: pointer;
        }
        
        .controls {
            margin-top: 20px;
        }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        .status {
            margin-top: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .error {
            color: red;
            font-weight: bold;
        }
        
        .info {
            color: #333;
        }
        
        .board-size-controls {
            margin-bottom: 10px;
        }
        
        .board-size-controls label {
            margin-right: 10px;
            font-weight: bold;
        }
        
        .board-size-controls select {
            padding: 5px 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background-color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Rugo - Go Game</h1>
        <canvas id="game-canvas" width="600" height="600"></canvas>
        
        <div class="controls">
            <div class="board-size-controls">
                <label for="board-size">Board Size:</label>
                <select id="board-size">
                    <option value="9">9×9</option>
                    <option value="13">13×13</option>
                    <option value="19" selected>19×19</option>
                </select>
            </div>
            <button id="new-game-btn">New Game</button>
            <button id="pass-btn">Pass</button>
        </div>
        
        <div class="status">
            <div id="status-text" class="info">Loading...</div>
            <div id="current-player">Current Player: Black</div>
        </div>
    </div>

    <script type="module">
        import init, { GoGame } from './pkg/rugo.js';

        let game = null;
        const canvas = document.getElementById('game-canvas');
        const statusText = document.getElementById('status-text');
        const currentPlayerText = document.getElementById('current-player');

        async function initGame() {
            try {
                statusText.textContent = "Initializing Go Game...";
                statusText.className = "info";
                
                // Initialize the wasm module
                await init();
                
                statusText.textContent = "Creating game instance...";
                
                // Get selected board size
                const boardSize = parseInt(document.getElementById('board-size').value);
                
                // Create game instance with selected size
                game = GoGame.new_with_size(canvas, boardSize);
                
                statusText.textContent = `Go Game Ready! (${boardSize}×${boardSize})`;
                
                setupEventListeners();
                drawBoard();
                
            } catch (error) {
                console.error('Failed to initialize game:', error);
                statusText.textContent = `Error: ${error}`;
                statusText.className = "error";
            }
        }

        function setupEventListeners() {
            // Canvas click handler
            canvas.addEventListener('click', (event) => {
                if (!game) return;
                
                const rect = canvas.getBoundingClientRect();
                const canvasX = event.clientX - rect.left;
                const canvasY = event.clientY - rect.top;
                
                // Get current board size
                const currentBoardSize = game.get_board_size();
                
                // Calculate board layout (same as in drawBoard)
                const width = canvas.width;
                const height = canvas.height;
                const cellSize = Math.min(width, height) / (currentBoardSize + 1);
                const boardPixelSize = cellSize * (currentBoardSize - 1);
                const offsetX = (width - boardPixelSize) / 2;
                const offsetY = (height - boardPixelSize) / 2;
                
                // Convert canvas coordinates to board coordinates
                const boardX = Math.round((canvasX - offsetX) / cellSize);
                const boardY = Math.round((canvasY - offsetY) / cellSize);
                
                // Check if click is within board bounds
                if (boardX >= 0 && boardX < currentBoardSize && boardY >= 0 && boardY < currentBoardSize) {
                    try {
                        game.handle_board_click(boardX, boardY);
                        drawBoard();
                    } catch (error) {
                        console.error('Click handling error:', error);
                    }
                }
            });

            // New game button
            document.getElementById('new-game-btn').addEventListener('click', () => {
                initGame();
            });

            // Pass button
            document.getElementById('pass-btn').addEventListener('click', () => {
                // TODO: Implement pass functionality
                console.log('Pass clicked');
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                if (game) {
                    const canvas = document.getElementById('game-canvas');
                    try {
                        game.resize(canvas.width, canvas.height);
                        render();
                    } catch (error) {
                        console.error('Resize error:', error);
                    }
                }
            });
        }

        function drawBoard() {
            if (!game) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Get current board size
            const currentBoardSize = game.get_board_size();
            
            // Clear canvas
            ctx.fillStyle = '#DEB887';
            ctx.fillRect(0, 0, width, height);
            
            // Draw grid lines
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 1;
            
            const cellSize = Math.min(width, height) / (currentBoardSize + 1);
            const boardPixelSize = cellSize * (currentBoardSize - 1);
            const offsetX = (width - boardPixelSize) / 2;
            const offsetY = (height - boardPixelSize) / 2;
            
            // Draw horizontal lines (need boardSize lines for boardSize intersections)
            for (let i = 0; i < currentBoardSize; i++) {
                const y = offsetY + i * cellSize;
                ctx.beginPath();
                ctx.moveTo(offsetX, y);
                ctx.lineTo(offsetX + boardPixelSize, y);
                ctx.stroke();
            }
            
            // Draw vertical lines (need boardSize lines for boardSize intersections)
            for (let i = 0; i < currentBoardSize; i++) {
                const x = offsetX + i * cellSize;
                ctx.beginPath();
                ctx.moveTo(x, offsetY);
                ctx.lineTo(x, offsetY + boardPixelSize);
                ctx.stroke();
            }
            
            // Draw star points based on board size
            let starPoints = [];
            if (currentBoardSize === 19) {
                starPoints = [
                    [3, 3], [9, 3], [15, 3],
                    [3, 9], [9, 9], [15, 9],
                    [3, 15], [9, 15], [15, 15]
                ];
            } else if (currentBoardSize === 13) {
                starPoints = [
                    [3, 3], [3, 9], [9, 3], [9, 9], // corners
                    [6, 6] // center
                ];
            } else if (currentBoardSize === 9) {
                starPoints = [
                    [2, 2], [2, 6], [6, 2], [6, 6], // corners  
                    [4, 4] // center
                ];
            }
            
            ctx.fillStyle = '#000';
            for (let [sx, sy] of starPoints) {
                const x = offsetX + sx * cellSize;
                const y = offsetY + sy * cellSize;
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, 2 * Math.PI);
                ctx.fill();
            }
            
            // Draw stones
            for (let y = 0; y < currentBoardSize; y++) {
                for (let x = 0; x < currentBoardSize; x++) {
                    const state = game.get_board_state(x, y);
                    if (state !== 0) {
                        const centerX = offsetX + x * cellSize;
                        const centerY = offsetY + y * cellSize;
                        const radius = cellSize * 0.4;
                        
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                        
                        if (state === 1) { // Black
                            ctx.fillStyle = '#000';
                        } else { // White
                            ctx.fillStyle = '#FFF';
                            ctx.strokeStyle = '#000';
                            ctx.lineWidth = 2;
                        }
                        
                        ctx.fill();
                        if (state === 2) {
                            ctx.stroke();
                        }
                    }
                }
            }
            
            // Update current player display
            const player = game.get_current_player();
            currentPlayerText.textContent = `Current Player: ${player === 1 ? 'Black' : 'White'}`;
        }

        // Start the game
        initGame();
    </script>
</body>
</html>
